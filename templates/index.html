<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CVE List</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; cursor: pointer; }
        button, select { padding: 6px 12px; margin: 5px; cursor: pointer; }
        .filter { margin-bottom: 10px; }
        tr:hover { background-color: #f1f1f1; }
    </style>
</head>
<body>
    <h1>CVE List</h1>

    <!-- Table for CVEs -->
    <div>
        Total Records in DB: <span id="totalCount">0</span>
    </div>

    <table id="cveTable">
        <thead>
            <tr>
                <th>S.No</th>
                <th onclick="sortCVEs('cve_id')">CVE ID</th>
                <th onclick="sortCVEs('identifier')">Identifier (Email)</th>
                <th onclick="sortCVEs('published')">Publish Date</th>
                <th onclick="sortCVEs('last_modified')">Last Modified Date</th>
                <th onclick="sortCVEs('status')">Status</th>
            </tr>
        </thead>
        <tbody>
            <!-- CVE rows will be injected here -->
        </tbody>
    </table>

     <div class="page-info">
        <button onclick="prevPage()">Previous</button>
        <span id="pageInfo">1-10 of 0 | Page 1 of 1</span>
        <button onclick="nextPage()">Next</button>

        Results per Page: 
        <select id="limit" onchange="changeLimit()">
            <option value="10" selected>10</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <script>
        let skip = 0;
        let limit = parseInt(document.getElementById('limit').value);
        let currentSort = "published";
        let currentOrder = "desc";
        let totalRecords = 0;

        async function fetchCVEs() {
            limit = parseInt(document.getElementById('limit').value);
            const url = `/cves?skip=${skip}&limit=${limit}&sort_by=${currentSort}&order=${currentOrder}`;
            const res = await fetch(url);
            const data = await res.json();

            totalRecords = data.count;
            document.getElementById('totalCount').innerText = totalRecords;

            const tbody = document.querySelector('#cveTable tbody');
            tbody.innerHTML = '';

            data.data.forEach((cve, index) => {
                const row = document.createElement('tr');
                row.onclick = () => { window.location.href = `/cves/${cve.cve_id}/view`; };
                row.innerHTML = `
    <td>${skip + index + 1}</td>
    <td>${cve.cve_id}</td>
    <td>${cve.identifier || ''}</td>
    <td>${cve.published ? new Date(cve.published).toLocaleDateString() : ''}</td>
    <td>${cve.last_modified ? new Date(cve.last_modified).toLocaleDateString() : ''}</td>
    <td>${cve.status || ''}</td>
`;

                tbody.appendChild(row);
            });

            // Update page info: show "1-10 of 237 | Page 1 of 24"
            const start = skip + 1;
            const end = Math.min(skip + limit, totalRecords);
            const totalPages = Math.ceil(totalRecords / limit);
            const currentPage = Math.floor(skip / limit) + 1;
            document.getElementById('pageInfo').innerText = `${start}-${end} of ${totalRecords} | Page ${currentPage} of ${totalPages}`;
        }

        function nextPage() {
            if (skip + limit < totalRecords) {
                skip += limit;
                fetchCVEs();
            }
        }

        function prevPage() {
            if (skip >= limit) {
                skip -= limit;
                fetchCVEs();
            }
        }

        function changeLimit() {
            skip = 0;
            fetchCVEs();
        }

        function sortCVEs(field) {
            if (currentSort === field) {
                currentOrder = currentOrder === "desc" ? "asc" : "desc";
            } else {
                currentSort = field;
                currentOrder = "desc";
            }
            fetchCVEs();
        }

        // Initial load
        fetchCVEs();
    </script>
</body>
</html>
